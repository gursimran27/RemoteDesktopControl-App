<html lang="en">
  <head>
    <title>Screecast Viewer</title>
    <style>
      body {
        background: linear-gradient(45deg, #7b0909, #6771b8b8);
        margin: 0;
        padding: 0;
        display: flex;
        justify-content: center;
        align-items: center;
        height: 100vh;
        overflow: hidden;
      }

      img {
        max-width: 100%;
        max-height: 100%;
        object-fit: contain; /* Ensures the aspect ratio is maintained */
      }
    </style>
  </head>
  <body>
    <img />

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/3.0.4/socket.io.js"
      crossorigin="anonymous"
    ></script>

    <script>
      let remoteUserScreenSize = null;
      window.onload = function () {
        var room = prompt("Please enter room ID : ");
        // Check if the user clicked Cancel or left the input empty

        if (room === null) {
          window.location.href =
            "https://remotedesktopcontrol-app.onrender.com/";
          return;
        }

        if (room.trim().length == 0) {
          alert("Room ID is mandatory to join");
          window.location.href =
            "https://remotedesktopcontrol-app.onrender.com/";
          return;
        }

        socket = io.connect("https://remotedesktopcontrol-app.onrender.com/");

        socket.emit("join-message", room);
        socket.on("screen-data", function (imgStr, remoteScreenSize) {
          $("img").attr("src", "data:image/png;base64," + imgStr); //this is jQuery
          if (remoteUserScreenSize == null) {
            remoteUserScreenSize = remoteScreenSize;
          }
          console.log("remoteUserScreenSize = " + remoteUserScreenSize);
        });
        socket.on("end-session", function () {
          alert("session endedðŸ˜Š");
          window.location.href =
            "https://remotedesktopcontrol-app.onrender.com/";
        });

        $("img").mousemove(function (event) {
          const $img = $(this); // Use the current image being hovered over
          const renderedImageSize = $img[0].getBoundingClientRect(); // Get image dimensions

          // Calculate cursor position relative to the image
          const cursorX = event.clientX - renderedImageSize.left;
          const cursorY = event.clientY - renderedImageSize.top;

          // Ensure `remoteUserScreenSize` is defined and holds the remote screen dimensions
          const scaleX = remoteUserScreenSize.width / renderedImageSize.width;
          const scaleY = remoteUserScreenSize.height / renderedImageSize.height;

          // Map the cursor position to remote screen coordinates
          const remoteX = cursorX * scaleX;
          const remoteY = cursorY * scaleY;

          const viewerScreenSize = {
            width: window.innerWidth,
            height: window.innerHeight,
          };

          // Prepare data object to send
          const obj = {
            x: remoteX,
            y: remoteY,
            viewerScreenSize,
            room: room,
          };

          // Emit the mouse movement event via socket
          socket.emit("mouse-move", JSON.stringify(obj));

          // Optional: Log for debugging
          // console.log("Remote Coordinates:", obj);
        });

        $("img").click(function (e) {
          const obj = { room: room, type: "single-click" };
          socket.emit("mouse-click", JSON.stringify(obj));
        });

        $("img").dblclick(function (e) {
          const obj = { room: room, type: "double-click" };
          socket.emit("mouse-click", JSON.stringify(obj));
        });

        $("img").contextmenu(function (e) {
          e.preventDefault(); // Prevent the default context menu from appearing
          const obj = { room: room, type: "right-click" };
          socket.emit("mouse-click", JSON.stringify(obj));
        });

        $(window).bind("keyup", function (e) {
          const keyMapping = {
            Backspace: "backspace",
            Enter: "enter",
            Shift: "shift",
            Control: "ctrl",
            Alt: "alt",
            CapsLock: "capslock",
            Space: "space",
            ArrowUp: "up",
            ArrowDown: "down",
            ArrowLeft: "left",
            ArrowRight: "right",
            Esc: "escape",
            Tab: "tab",
            Delete: "delete",
            Insert: "insert",
            Home: "home",
            End: "end",
            PageUp: "pageup",
            PageDown: "pagedown",
            F1: "f1",
            F2: "f2",
            F3: "f3",
            F4: "f4",
            F5: "f5",
            F6: "f6",
            F7: "f7",
            F8: "f8",
            F9: "f9",
            F10: "f10",
            F11: "f11",
            F12: "f12",
            NumLock: "numlock",
            ScrollLock: "scrolllock",
            Pause: "pause",
            PrintScreen: "printscreen",
            Windows: "windows",
          };
          let key = e.key;
          
          // If the key is alphanumeric (letters or digits), convert it to lowercase
          if (/[a-zA-Z0-9]/.test(key)) {
            key = key.toLowerCase();
          }

          // Map special keys
          key = keyMapping[key] || key; // Use the keyMapping for special keys or the regular key

          var obj = { key: key, room: room };
          socket.emit("type", JSON.stringify(obj));
        });
      };
    </script>
  </body>
</html>
